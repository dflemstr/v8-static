sudo: true
dist: trusty
language: generic

matrix:
  include:
    - os: linux
      env: TARGET=x86_64-unknown-linux-gnu
    - os: osx
      osx_image: xcode8
      env: TARGET=x86_64-apple-darwin

script:
  - git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
  - export PATH=`pwd`/depot_tools:"$PATH"
  - fetch v8
  - cat extra.gn >> v8/BUILD.gn
  - cd v8
  - gn gen out.gn/build --script-executable=/usr/bin/python2 --args='is_component_build=false is_debug=false is_official_build=true optimize_for_size=true v8_use_snapshot=true v8_use_external_startup_data=false v8_enable_i18n_support=false'
  - ninja -C out.gn/build
  - cd ..
  - gzip -k v8/out.gn/build/obj/libv8uber.a
  - export UPLOAD_DIR=upload/$TARGET/$(cd v8; git describe --tags)
  - mkdir -p "$UPLOAD_DIR"
  - cp v8/out.gn/build/obj/libv8uber.a.gz "$UPLOAD_DIR"

deploy:
  - provider: s3
    access_key_id: AKIAJE27ZGMR45IXA6OA
    secret_access_key: ${S3_KEY}
    bucket: record-query
    region: eu-west-1
    skip_cleanup: true
    local_dir: upload
    upload-dir: v8
    on:
      repo: dflemstr/v8-static

