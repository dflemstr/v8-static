sudo: true
dist: trusty
language: generic

matrix:
  include:
    - os: linux
      env: TARGET=x86_64-unknown-linux-gnu
    - os: osx
      osx_image: xcode7.1
      env: TARGET=x86_64-apple-darwin

script:
  - git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
  - export PATH=`pwd`/depot_tools:"$PATH"
  - fetch v8
  - cat extra.gn >> v8/BUILD.gn
  - cd v8
  - gn gen out.gn/build --script-executable=/usr/bin/python2 --args='is_component_build=false is_debug=false is_official_build=true optimize_for_size=true v8_use_snapshot=true v8_use_external_startup_data=false v8_enable_i18n_support=false'
  - ninja -C out.gn/build v8uber d8
  - cd ..
  - mkdir v8-build
  - mkdir v8-build/include
  - mv -r v8/include/* "v8-build/include"
  - mkdir v8-build/lib
  - mv v8/out.gn/build/obj/libv8uber.a v8-build/lib
  - tar -cvzf v8-build.tar.gz v8-build
  - export UPLOAD_DIR=upload/$TARGET/$(v8/out.gn/build/d8 -e "var v = version(); print(v.substring(0, v.indexOf(' ')))")-$(cat v8/.git/HEAD)
  - mkdir -p "$UPLOAD_DIR"
  - mv v8-build.tar.gz "$UPLOAD_DIR"

deploy:
  - provider: s3
    access_key_id: AKIAJE27ZGMR45IXA6OA
    secret_access_key: ${S3_KEY}
    bucket: record-query
    region: eu-west-1
    skip_cleanup: true
    local_dir: upload
    upload-dir: v8
    on:
      repo: dflemstr/v8-static

